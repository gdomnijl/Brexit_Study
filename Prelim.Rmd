---
title: "BriExit Survey Data Exploration"
output:
  html_document: default
  html_notebook: default
---
## Week 3 Report
## Goal
After first meeting, we will try the first approach:

* Series 1. To visualize the general "opinion landscape" on leave/stay in the EU for each wave of survey. 
* Series 2. Further investigate the difference between sub demographic groups:  
    + Age_group
    + Education
    + Social Economic Status (?)
    + Urban rural
    + Party ID
    + Political philosophy  
    + Conservative -> break from EU
    + Pro-labour -> stay in EU


```{r, message = FALSE, warning= FALSE, echo=FALSE}
# Read in
#library(readstata13)
library(tidyverse)
library(gridExtra)
dat <- read.csv("wt_age_origin.csv")
```
#Note:
\# of weights that said yes/ # of weights that said yes + said no 

  
#Series One:
## Collect general stay percent from each wave
```{r, echo = FALSE, warning=FALSE}
stay_p <-c()
leave_p <- c()
for(i in 1:13){
  ## missing vote for wave 5 ??? => check original dataset 
  ## find wt_new_w10

  if(i!=5){
  wave_name <- paste0("^wave",i,"$")
  wave_col <- grep(wave_name, colnames(dat))
  
  vote_name <- paste0("^euRefVoteW",i,"$")
  vote_col<-grep(vote_name,colnames(dat))
  
  if(i<=9){
    wt_name <- paste0("wt_core_W",i)
    wt_col <- grep(wt_name,colnames(dat))
  }else if (i == 10){
    wt_name <- paste0("wt_full_W",i)
    wt_col <- grep(wt_name,colnames(dat))
  }else{
    wt_name <- paste0("wt_new_W",i)
    wt_col <- grep(wt_name,colnames(dat))
  }
  wave <- dat %>%
    filter(dat[,wave_col]==1) 
  
  wave_stay <- wave %>% 
    filter(wave[,vote_col]=="Stay/remain in the EU")
  wave_leave <- wave %>%
    filter(wave[,vote_col]=="Leave the EU")
  
  total <- sum(wave[,wt_col], na.rm = TRUE)
  stay <- sum(wave_stay[,wt_col], na.rm = TRUE)
  leave <- sum(wave_leave[,wt_col], na.rm = TRUE)
  
  stay_p <- c(stay_p, stay/total)
  leave_p <- c(leave_p, leave/total)
  }
}
```

```{r}
## plot wave 1 ~ 13 except wave 5
wave <- c(1:4,6:13)
opinion_p <- data.frame(wave,stay_p,leave_p)%>%
  gather(atti, percent,-wave)
```

```{r eval = FALSE,echo = FALSE}
### bar graph
opinion_p %>% 
  ggplot(aes(y = percent, x = wave,fill = atti))+ 
  geom_bar(stat="identity",position=position_dodge()) +
  ylab("% vote over TOTAL reponse") +
  xlab("Across waves 1 ~ 13 (except 5)")
```


### line graph
```{r echo = FALSE}
opinion_p %>% 
  ggplot(aes(y = percent, x = wave,group = atti, colour = atti, shape = atti))+ 
  geom_line(size=0.8) + 
              geom_point(size=2, fill="white") +
  ylab("% vote over TOTAL reponse") +
  xlab("Across waves 1 ~ 13 (EXCEPT WAVE 5)") + 
  scale_x_continuous(breaks=seq(1,13))+
  scale_colour_discrete(name="Votes",
                      breaks=c("leave_p", "stay_p"),
                      labels=c("Leave the EU", "Stay/remain in the EU"))+
  scale_shape_discrete(name="Votes",
                        breaks=c("leave_p", "stay_p"),
                        labels=c("Leave the EU", "Stay/remain in the EU"))
```



#Series Two: Look at demographic subgroups 
## Step 1: create new dataset

The original dataset is person-level. It looks like: 
```{r, echo = FALSE}
head(dat[,c(2,50,37:49,3:5,71:75)])
```

```{r tidy = TRUE, echo = FALSE}
demo_dat <- dat %>% select(id,country,ageW1,countryOfBirth)
dat2 <- c()
for(i in 1:13){
  if(i!= 5){
  wave_name <- paste0("^wave",i,"$")
  wave_col <- grep(wave_name, colnames(dat))
  
  vote_name <- paste0("^euRefVoteW",i,"$")
  vote_col<-grep(vote_name,colnames(dat))
  
  if(i<=9){
    wt_name <- paste0("^wt_core_W",i,"$")
    wt_col <- grep(wt_name,colnames(dat))
  }else if (i == 10){
    wt_name <- paste0("^wt_full_W",i,"$")
    wt_col <- grep(wt_name,colnames(dat))
  }else{
    wt_name <- paste0("^wt_new_W",i,"$")
    wt_col <- grep(wt_name,colnames(dat))
  }
  
  wave_i <- dat %>% 
    filter(dat[,wave_col]==1) %>%
    select(id, wt_col,vote_col, -wave_col) %>%
    mutate(wave = i) 
  
  names(wave_i) <- sub(wt_name, "wt", names(wave_i))
  names(wave_i) <- sub(vote_name, "vote", names(wave_i))
  
  dat2 <- rbind2(dat2,wave_i)
  }
}

ins_dat <- dat2 %>% 
  inner_join(demo_dat)
```

After manipulation, we get a wave-level data that looks like: 
```{r}
head(arrange(ins_dat, id)) 
```

## Step 2: graphs 
### Country of origin 

__Note: wierd drop in England origin__
"For each demographic subgroup, how does the stay/leave opinion change over time?"
```{r tidy = TRUE, echo = FALSE}
# number of responses for each subgroup in each wave

dat_origin <- ins_dat %>%
  group_by(wave, countryOfBirth, vote) %>%
  summarise(group_vote = sum(wt, na.rm = TRUE)) %>%
  filter(vote == "Leave the EU" | vote == "Stay/remain in the EU") %>%
  spread(vote,group_vote) %>%
  plyr::rename(c("Stay/remain in the EU" = "Stay",
         "Leave the EU" = "Leave")) %>%
  mutate(stay_leave_ratio = Stay/Leave)

## color
color <- c("#b10026", "#fc4e2a", "#fd8d3c", "#969696",  "#252525","#238b45",
           "#7570b3", "#e7298a", "#a6761d", "#d95f02")
l2 <- c("Other: Commonwealth member country", 
 "Other: European Union member country",
 "Other: Rest of world",            
 "Prefer not to answer",
 NA,
"Republic of Ireland",                
 "Scotland",                        
 "Wales",   
"England",                           
"Northern Ireland")

## reordered the level
dat_origin$countryOfBirth <- factor(dat_origin$countryOfBirth, levels = l2)


dat_origin %>%
  ggplot(aes(x = wave,y = stay_leave_ratio, group = countryOfBirth, colour = countryOfBirth)) + geom_point() + geom_line() +  ylab("Stay-leave ratio of the country of birth")+
  xlab("Across waves 1 ~ 13 (EXCEPT WAVE 5)") + 
  scale_x_continuous(breaks=seq(1,13)) #+   scale_colour_manual(values=color)


```


```{r echo = FALSE}
dat_leave <- ins_dat %>% 
  filter(vote == "Leave the EU") %>%
  select(-vote) %>%
  group_by(wave,countryOfBirth) %>%
  summarise(leave = sum(wt, na.rm = TRUE))
  
dat_stay <- ins_dat %>% 
  filter(vote == "Stay/remain in the EU") %>%
  select(-vote)%>%
  group_by(wave,countryOfBirth) %>%
  summarise(stay = sum(wt, na.rm = TRUE))

## Note: the % is over all 'Leave' voters in that wave 
dat_leave_total <- ins_dat %>%
  filter(vote == "Leave the EU") %>%
  group_by(wave) %>%
  summarise(leave_total = sum(wt, na.rm = TRUE))

dat_stay_total <- ins_dat %>%
  filter(vote == "Stay/remain in the EU") %>%
  group_by(wave) %>%
  summarise(stay_total = sum(wt, na.rm = TRUE))

dat_origin_p <- dat_leave_total %>%
  inner_join(dat_leave) %>%
  inner_join(dat_stay) %>%
  inner_join(dat_stay_total) %>%
  mutate(stay_p = stay/stay_total,
         leave_p = leave/leave_total)


leave_tot <- dat_origin_p %>%
  ggplot(aes(y = leave_p, x = wave, group = countryOfBirth, colour = countryOfBirth))+
  geom_line() + 
  geom_point() + 
  ylab("% of voters voted 'leave' of the country of birth")+
  xlab("Across waves 1 ~ 13 (EXCEPT WAVE 5)") + 
  scale_x_continuous(breaks=seq(1,13))+ theme(legend.position="none")

stay_tot <- dat_origin_p %>%
  ggplot(aes(y = stay_p, x = wave, group = countryOfBirth, colour = countryOfBirth))+
  geom_line() + 
  geom_point() + 
  ylab("% of voters voted 'stay' of the country of birth")+
  xlab("Across waves 1 ~ 13 (EXCEPT WAVE 5)") + 
  scale_x_continuous(breaks=seq(1,13)) 

#grid.arrange(leave_tot, stay_tot, nrow = 1)
```


```{r echo = FALSE}

```

### Examine people of English origin vote change
```{r echo = FALSE}
#origin
En_vote <- ins_dat %>%
  filter(countryOfBirth == "England") %>%
  group_by(wave, vote) %>%
  summarise(wt_vote = sum(wt, na.rm = TRUE))

En_vote %>%
  ggplot(aes(x = wave, y = wt_vote, group = vote, color = vote)) +
  geom_point() + geom_line() + ggtitle("Country of Birth: 'England'")+ scale_x_continuous(breaks=seq(1,13))
```

## NA
```{r}
NA_vote <- ins_dat %>%
  filter(is.na(countryOfBirth)) %>%
  group_by(wave, vote) %>%
  summarise(wt_vote = sum(wt, na.rm = TRUE))

NA_vote %>%
  ggplot(aes(x = wave, y = wt_vote, group = vote, color = vote)) +
  geom_point() + geom_line() + scale_x_continuous(breaks=seq(1,13)) +ylab("Votes (weighted raw counts)") + ggtitle("Country of Birth: 'Prefer not to answer'")
```


## international 
```{r echo = FALSE}
In_vote <- ins_dat %>%
  filter(countryOfBirth == "Other: Rest of world") %>%
  group_by(wave, vote) %>%
  summarise(wt_vote = sum(wt, na.rm = TRUE))

In_vote %>%
  ggplot(aes(x = wave, y = wt_vote, group = vote, color = vote)) +
  geom_point() + geom_line() + ggtitle("Country of Birth: 'Rest of the world'") + scale_x_continuous(breaks=seq(1,13))
```

### Look into total demographic change (country of origin)
** Very wierd **
```{r}
 ins_dat %>%
  group_by(wave, countryOfBirth) %>%
  summarise(count = sum(wt, na.rm = TRUE)) %>%
  ggplot(aes(x = wave, y = count, group = countryOfBirth, color = countryOfBirth)) + geom_point() + geom_line() + ylab("Total response (weighted)") + ggtitle("Demographic change/check across survey waves")
```


### Next time: 
### Opinion divide within each group of country origin
```{r eval = FALSE, echo = FALSE}
dat_total <- ins_dat %>%
  group_by(wave, vote) %>%
  summarize(each_origin_total = sum(wt,na.rm=TRUE))%>%
  spread(vote,each_origin_total)

dat_ <- ins_dat %>% 
  group_by(wave,countryOfBirth,vote) %>%
  summarise(count = sum(wt, na.rm = TRUE))%>%
  inner_join(dat_total) %>%
  mutate(stay_p = stay/count,
         leave_p = leave/count) %>%
  gather(atti, percent, -countryOfBirth, -wave,-vote,)
```

### continue HERE
```{r eval = FALSE, echo = FALSE}
  ggplot(aes(y = percent, x = wave,fill = atti))+ 
  geom_bar(stat="identity",position=position_dodge()) +
  ylab("% vote over total reponse (including 'I don't know')") +
  xlab("Across waves 1 ~ 13 (except 5)")
```


```{r eval = FALSE, echo = FALSE}

## Reduce to a condensed dataset (used code)
condensed <- dat[,c(1:67,72,75,index)]
write.csv(condensed, "wt_age_origin.csv")

index <-c()
for(i in 1:13){
  reg <- paste0("^euRefVoteW",i,"$")
  col_num<-grep(reg,colnames(dat))
  index <- c(index, col_num)
}

grep("^euRefVoteW1$", colnames(dat)) #265
```


## Next Goal  
* Mark 3 critical events 
* Continuous waves (1~13)
** Determine the most continuous waves (balance sample size)
* Other demographic 

#TODO:  
  * missing vote for wave 5 ??? => check original dataset 
  * find wt_new_w10

```{r eval = TRUE}
## create a dataset that is wave specific 
for(i in 1: 13){
  #wave_num <- paste0("wave",i);
  dat %>% filter(wave1 == 1, euRefVoteW1== "Stay/remain in the EU") %>% 
    summarise(stay = sum(wt_core_W1, na.rm = TRUE))
  
  dat %>% filter(wave1 == 1) %>% summarise(total = sum(wt_core_W1, na.rm = TRUE))
  
  dat %>% group_by()
}

t <- dat %>%
  filter(wave1==1) %>%
  group_by(euRefVoteW1) %>%
  summarise(opinion_count = sum(wt_core_W1, na.rm = TRUE))
  
  
t2 <- dat %>%  
  filter(wave1==1) %>%
  inner_join(t) %>%
  mutate(total_count = sum(wt_core_W1, na.rm = TRUE))%>%
  mutate(stay_p = opinion_count/total_count) %>%
  filter(euRefVoteW1 == "Stay/remain in the EU") %>%
  select(stay_p) %>%
  unique()

```

