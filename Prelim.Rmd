---
title: "BriExit Survey Data Exploration"
output:
  html_document: default
  html_notebook: default
---
## Goal
After first meeting, we will try the first approach:

* Series 1. To visualize the general "opinion landscape" on leave/stay in the EU for each wave of survey. 
* Series 2. Further investigate the difference between sub demographic groups:  
    + Age_group
    + Education
    + Social Economic Status (?)
    + Urban rural
    + Party ID
    + Political philosophy  
    + Conservative -> break from EU
    + Pro-labour -> stay in EU


```{r, message = FALSE, warning= FALSE, echo=FALSE}
# Read in
#library(readstata13)
library(tidyverse)

dat <- read.csv("data/wt_age_origin.csv")
```
#Note:
\# of weights that said yes/ # of weights that said yes + said no 

#Series One:
## Collect general stay percent from each wave
```{r, echo = FALSE, warning=FALSE}
stay_p <-c()
leave_p <- c()
for(i in 1:13){
  ## missing vote for wave 5 ??? => check original dataset 
  ## find wt_new_w10

  if(i!=5){
  wave_name <- paste0("^wave",i,"$")
  wave_col <- grep(wave_name, colnames(dat))
  
  vote_name <- paste0("^euRefVoteW",i,"$")
  vote_col<-grep(vote_name,colnames(dat))
  
  if(i<=9){
    wt_name <- paste0("wt_core_W",i)
    wt_col <- grep(wt_name,colnames(dat))
  }else if (i == 10){
    wt_name <- paste0("wt_full_W",i)
    wt_col <- grep(wt_name,colnames(dat))
  }else{
    wt_name <- paste0("wt_new_W",i)
    wt_col <- grep(wt_name,colnames(dat))
  }
  wave <- dat %>%
    filter(dat[,wave_col]==1) 
  
  wave_stay <- wave %>% 
    filter(wave[,vote_col]=="Stay/remain in the EU")
  wave_leave <- wave %>%
    filter(wave[,vote_col]=="Leave the EU")
  
  total <- sum(wave[,wt_col], na.rm = TRUE)
  stay <- sum(wave_stay[,wt_col], na.rm = TRUE)
  leave <- sum(wave_leave[,wt_col], na.rm = TRUE)
  
  stay_p <- c(stay_p, stay/total)
  leave_p <- c(leave_p, leave/total)
  }
}
```

```{r}
## plot wave 1 ~ 13 except wave 5
wave <- c(1:4,6:13)
opinion_p <- data.frame(wave,stay_p,leave_p)%>%
  gather(atti, percent,-wave)
```
### bar graph
```{r eval = TRUE,echo = FALSE}
opinion_p %>% 
  ggplot(aes(y = percent, x = wave,fill = atti))+ 
  geom_bar(stat="identity",position=position_dodge()) +
  ylab("% vote over total reponse (including 'I don't know')") +
  xlab("Across waves 1 ~ 13 (except 5)")
```


### line graph
```{r echo = FALSE}
opinion_p %>% 
  ggplot(aes(y = percent, x = wave,group = atti, colour = atti, shape = atti))+ 
  geom_line(size=0.8) + 
              geom_point(size=2, fill="white") +
  ylab("% vote over total reponse (including 'I don't know')") +
  xlab("Across waves 1 ~ 13 (EXCEPT WAVE 5)") + 
  scale_x_continuous(breaks=seq(1,13))+
  scale_colour_discrete(name="Votes",
                      breaks=c("leave_p", "stay_p"),
                      labels=c("Leave the EU", "Stay/remain in the EU"))+
  scale_shape_discrete(name="Votes",
                        breaks=c("leave_p", "stay_p"),
                        labels=c("Leave the EU", "Stay/remain in the EU"))
```


#Series Two: Look at demographic subgroups 
## Step 1: create new dataset
```{r tidy = TRUE, echo = FALSE}
demo_dat <- dat %>% select(id,country,ageW1,countryOfBirth)
dat2 <- c()
for(i in 1:13){
  if(i!= 5){
  wave_name <- paste0("^wave",i,"$")
  wave_col <- grep(wave_name, colnames(dat))
  
  vote_name <- paste0("^euRefVoteW",i,"$")
  vote_col<-grep(vote_name,colnames(dat))
  
  if(i<=9){
    wt_name <- paste0("^wt_core_W",i,"$")
    wt_col <- grep(wt_name,colnames(dat))
  }else if (i == 10){
    wt_name <- paste0("^wt_full_W",i,"$")
    wt_col <- grep(wt_name,colnames(dat))
  }else{
    wt_name <- paste0("^wt_new_W",i,"$")
    wt_col <- grep(wt_name,colnames(dat))
  }
  
  wave_i <- dat %>% 
    filter(dat[,wave_col]==1) %>%
    select(id, wt_col,vote_col, -wave_col) %>%
    mutate(wave = i) 
  
  names(wave_i) <- sub(wt_name, "wt", names(wave_i))
  names(wave_i) <- sub(vote_name, "vote", names(wave_i))
  
  dat2 <- rbind2(dat2,wave_i)
  }
}

ins_dat <- dat2 %>% 
  inner_join(demo_dat)
```


## Step 2: graphs 
### Country of origin 

__Note: wierd drop in England origin__
```{r tidy = TRUE, echo = FALSE}
dat_leave <- ins_dat %>% 
  filter(vote == "Leave the EU") %>%
  select(-vote) %>%
  group_by(wave,countryOfBirth) %>%
  summarise(leave = sum(wt, na.rm = TRUE))
  
dat_stay <- ins_dat %>% 
  filter(vote == "Stay/remain in the EU") %>%
  select(-vote)%>%
  group_by(wave,countryOfBirth) %>%
  summarise(stay = sum(wt, na.rm = TRUE))

## Note: the % is over all 'Leave' voters in that wave 
dat_leave_total <- ins_dat %>%
  filter(vote == "Leave the EU") %>%
  group_by(wave) %>%
  summarise(leave_total = sum(wt, na.rm = TRUE))

dat_stay_total <- ins_dat %>%
  filter(vote == "Stay/remain in the EU") %>%
  group_by(wave) %>%
  summarise(stay_total = sum(wt, na.rm = TRUE))

dat_origin_p <- dat_leave_total %>%
  inner_join(dat_leave) %>%
  inner_join(dat_stay) %>%
  inner_join(dat_stay_total) %>%
  mutate(stay_p = stay/stay_total,
         leave_p = leave/leave_total)


dat_origin_p %>%
  ggplot(aes(y = leave_p, x = wave, group = countryOfBirth, colour = countryOfBirth))+
  geom_line() + 
  geom_point() + 
  ylab("% of voters voted 'leave' of the country of birth")+
  xlab("Across waves 1 ~ 13 (EXCEPT WAVE 5)") + 
  scale_x_continuous(breaks=seq(1,13))
```


**same**

```{r echo = FALSE}
dat_origin_p %>%
  ggplot(aes(y = stay_p, x = wave, group = countryOfBirth, colour = countryOfBirth))+
  geom_line() + 
  geom_point() + 
  ylab("% of voters voted 'stay' of the country of birth")+
  xlab("Across waves 1 ~ 13 (EXCEPT WAVE 5)") + 
  scale_x_continuous(breaks=seq(1,13))
```


### Opinion divide within each group of country origin
```{r echo = FALSE}
dat_total <- ins_dat %>%
  group_by(wave, vote) %>%
  summarize(each_origin_total = sum(wt,na.rm=TRUE))%>%
  spread(vote,each_origin_total)

dat_ <- ins_dat %>% 
  group_by(wave,countryOfBirth,vote) %>%
  summarise(count = sum(wt, na.rm = TRUE))%>%
  inner_join(dat_total) %>%
  mutate(stay_p = stay/count,
         leave_p = leave/count) %>%
  gather(atti, percent, -countryOfBirth, -wave,-vote,)

```



## continue HERE
```{r eval = FALSE, echo = FALSE}
  ggplot(aes(y = percent, x = wave,fill = atti))+ 
  geom_bar(stat="identity",position=position_dodge()) +
  ylab("% vote over total reponse (including 'I don't know')") +
  xlab("Across waves 1 ~ 13 (except 5)")
```


## Check code 
```{r eval = FALSE, echo = FALSE}
dat_stay <- ins_dat %>% 
  filter(vote == "Stay/remain in the EU") %>%
  select(-vote)%>%
  group_by(wave,countryOfBirth) %>%
  summarise(stay = sum(wt, na.rm = TRUE))

dat_origin_p <- dat_total %>%
  inner_join(dat_leave) %>%
  inner_join(dat_stay) %>%
  select(wave,countryOfBirth,leave,stay) %
  ggplot(aes(y = percent, x = wave,fill = atti))+ 
  geom_bar(stat="identity",position=position_dodge()) +
  ylab("% vote over total reponse (including 'I don't know')") +
  xlab("Across waves 1 ~ 13 (except 5)")
```

```{r eval = FALSE,echo = FALSE}
dat_p %>%
  ggplot(aes(y = leave_p, x = wave, group = countryOfBirth, colour = countryOfBirth))+ 
  geom_line() + 
  geom_point() +
  ylab("% voted to leave EU") +
  xlab("Across waves 1 ~ 13 (EXCEPT WAVE 5)") + 
  scale_x_continuous(breaks=seq(1,13))+
  scale_colour_discrete(name="Votes",
                        breaks=c("leave_p", "stay_p"),
                        labels=c("Leave the EU", "Stay/remain in the EU"))+
  scale_shape_discrete(name="Votes",
                       breaks=c("leave_p", "stay_p"),
                       labels=c("Leave the EU", "Stay/remain in the EU"))
```


```{r eval = FALSE, echo = FALSE}

## Reduce to a condensed dataset (used code)
condensed <- dat[,c(1:67,72,75,index)]
write.csv(condensed, "wt_age_origin.csv")

index <-c()
for(i in 1:13){
  reg <- paste0("^euRefVoteW",i,"$")
  col_num<-grep(reg,colnames(dat))
  index <- c(index, col_num)
}

grep("^euRefVoteW1$", colnames(dat)) #265
```





```{r}
## create a dataset that is wave specific 
for(i in 1: 13){
  #wave_num <- paste0("wave",i);
  dat %>% filter(wave1 == 1, euRefVoteW1== "Stay/remain in the EU") %>% 
    summarise(stay = sum(wt_core_W1, na.rm = TRUE))
  
  dat %>% filter(wave1 == 1) %>% summarise(total = sum(wt_core_W1, na.rm = TRUE))
  
  dat %>% group_by()
}

t <- dat %>%
  filter(wave1==1) %>%
  group_by(euRefVoteW1) %>%
  summarise(opinion_count = sum(wt_core_W1, na.rm = TRUE))
  
  
t2 <- dat %>%  
  filter(wave1==1) %>%
  inner_join(t) %>%
  mutate(total_count = sum(wt_core_W1, na.rm = TRUE))%>%
  mutate(stay_p = opinion_count/total_count) %>%
  filter(euRefVoteW1 == "Stay/remain in the EU") %>%
  select(stay_p) %>%
  unique()

```

